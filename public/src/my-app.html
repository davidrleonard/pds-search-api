<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html"/>
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html"/>
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html"/>
<link rel="import" href="../bower_components/px-branding-bar/px-branding-bar.html"/>
<link rel="import" href="../bower_components/px-theme/px-theme-styles.html"/>

<link rel="import" href="../css/app-styles.html">

<dom-module id="my-app">
  <template>
    <style include="px-theme-styles"></style>
    <style include="app-styles"></style>
    <style>
      :host {
        display: block;
      }
    </style>

    <px-branding-bar application-title="PDS Site Realtime Stats"></px-branding-bar>

    <div class="app">
      <!-- SEARCHES -->
      <div class="app__searches">
        <h2 class="section-title heading--section">Searches</h2>

        <div class="result-list">
          <template is="dom-repeat" items="[[searches]]" as="search">
            <template is="dom-if" if="[[_createdAtDiffThanLast(search.createdAt, index, searches)]]">
              <p class="zeta search-result-created-at">[[search.createdAt]]</p>
            </template>
            <div class$="search-result [[_getSearchResultsCountClass(search.resultsCount)]]">
              <div class="search-result__term">
                <p class="label search-result__label">Term</p>
                <p class="delta search-result__value">[[search.term]]</p>
              </div>
              <div class="search-result__results-count">
                <p class="label search-result__label"># of Results</p>
                <p class="delta search-result__value">[[search.resultsCount]]</p>
              </div>
            </div>
          </template>
        </div>
      </div>

      <!-- VIEWS -->
      <div class="app__views">
        <h2 class="section-title heading--section">Views</h2>

        <div class="result-list">
          <template is="dom-repeat" items="[[views]]" as="view">
            <template is="dom-if" if="[[_createdAtDiffThanLast(view.createdAt, index, views)]]">
              <p class="zeta search-result-created-at">[[view.createdAt]]</p>
            </template>

            <a class="view-result" href$="https://www.predix-ui.com[[view.path]]" target="_blank">
              <p class="label view-result__label">[[_getViewPageType(view.path)]]</p>
              <p class="delta view-result__value">[[view.name]]</p>
            </a>
          </template>
        </div>
      </div>
    </div>
  </template>

  <script>
    (() => {
      // Gesture events like tap and track generated from touch will not be
      // preventable, allowing for better scrolling performance.
      Polymer.setPassiveTouchGestures(true);

      class MyApp extends Polymer.Element {
        static get is() { return 'my-app'; }

        static get properties() {
          return {
            searches: {
              type: Array,
              value: () => []
            },
            views: {
              type: Array,
              value: () => []
            }
          };
        }

        connectedCallback() {
          super.connectedCallback();

          /* Listen for new search events and add them to the page */
          const searchRef = firebase.database().ref('/search').limitToLast(50);
          searchRef.on('child_added', data => {
            let {term, results, resultsCount, _createdAt} = data.val();
            this.searches = [{
              term,
              results,
              resultsCount,
              _createdAt,
              createdAt: fromNow(_createdAt)
            }].concat(this.searches);
          });

          /* Listen for new view events and add them to the page */
          const viewRef = firebase.database().ref('/view').limitToLast(50);
          viewRef.on('child_added', data => {
            let {name, path, _createdAt} = data.val();
            this.views = [{
              name,
              path,
              _createdAt,
              createdAt: fromNow(_createdAt)
            }].concat(this.views);
          });

          /* Update the `createdAt` strings every minute */
          setInterval(() => {
            console.log('Updating created at strings.')
            this.searches = this.searches.map(search => {
              search.createdAt = fromNow(search._createdAt);
              return search;
            });
            this.views = this.views.map(view => {
              view.createdAt = fromNow(view._createdAt);
              return view;
            });
          }, 60000);
        }

        _getSearchResultsCountClass(count) {
          if (count > 0) {
            return 'search-result--some-found';
          }
          return 'search-result--none-found';
        }

        _createdAtDiffThanLast(createdAt, currentIndex, results) {
          if (currentIndex === 0) {
            return true;
          }
          if (createdAt !== results[currentIndex-1].createdAt) {
            return true;
          }
          return false;
        }

        _getViewPageType(path) {
          const section = path.split('/')[2];
          if (section) {
            if (section === 'elements') {
              return 'Component Docs';
            }
            if (section === 'css') {
              return 'CSS Docs';
            }
            if (section === 'develop') {
              return 'Developer Guides';
            }
            if (section === 'design') {
              return 'Design Guidelines';
            }
            if (section === 'about') {
              return 'Getting Started';
            }
            return capitalize(section);
          }
          return 'Unknown';
        }
      }

      window.customElements.define(MyApp.is, MyApp);

      /**
       * Capitalizes the first letter of a string and returns it.
       */
      function capitalize(str) {
        return str[0].toUpperCase() + str.slice(1);
      }

      /**
       * Formats the time since a date passed as a human-readable string.
       *
       * @example
       *
       *     var pastDate = new Date('2017-10-01T02:30');
       *     var message = fromNow(pastDate);
       *     //=> '2 days ago'
       *
       * @param  {Date} Native JavaScript Date object
       * @return {string}
       */
      function fromNow(date) {
        var seconds = Math.floor((new Date() - date) / 1000);
        var years = Math.floor(seconds / 31536000);
        var months = Math.floor(seconds / 2592000);
        var days = Math.floor(seconds / 86400);

        if (days > 548) {
          return years + ' years ago';
        }
        if (days >= 320 && days <= 547) {
          return 'a year ago';
        }
        if (days >= 45 && days <= 319) {
          return months + ' months ago';
        }
        if (days >= 26 && days <= 45) {
          return 'a month ago';
        }

        var hours = Math.floor(seconds / 3600);

        if (hours >= 36 && days <= 25) {
          return days + ' days ago';
        }
        if (hours >= 22 && hours <= 35) {
          return 'a day ago';
        }

        var minutes = Math.floor(seconds / 60);

        if (minutes >= 90 && hours <= 21) {
          return hours + ' hours ago';
        }
        if (seconds >= 90 && minutes <= 89) {
          return 'in the last hour';
        }
        if (seconds >= 0 && seconds <= 89) {
          return 'just now';
        }
      }
    })();
  </script>
</dom-module>
