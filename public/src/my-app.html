<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html"/>
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html"/>
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html"/>
<link rel="import" href="../bower_components/px-branding-bar/px-branding-bar.html"/>
<link rel="import" href="../bower_components/px-dark-theme/px-dark-theme-styles.html"/>
<link rel="import" href="components/app-results-list.html">
<link rel="import" href="../css/app-styles.html">

<dom-module id="my-app">
  <template>
    <style include="px-dark-theme-styles"></style>
    <style include="app-styles"></style>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }
    </style>

    <px-branding-bar application-title="PDS Site Realtime Stats"></px-branding-bar>

    <div class="app">
      <div class="app-searches">
        <app-results-list title="Searches" results="[[searches]]"></app-result-list>
      </div>
      <div class="app-views">
        <app-results-list title="Views" results="[[views]]"></app-result-list>
      </div>
    </div>
  </template>

  <script>
    {
      // Gesture events like tap and track generated from touch will not be
      // preventable, allowing for better scrolling performance.
      Polymer.setPassiveTouchGestures(true);

      class MyApp extends Polymer.Element {
        static get is() { return 'my-app'; }

        static get properties() {
          return {
            searches: {
              type: Array,
              value: () => []
            },
            views: {
              type: Array,
              value: () => []
            }
          };
        }

        connectedCallback() {
          super.connectedCallback();

          /* Listen for new search events and add them to the page */
          const searchRef = firebase.database().ref('/search').limitToLast(50);
          searchRef.on('child_added', data => {
            const child = data.val();
            const label = 'Term';
            const value = child.term;
            const created = child._createdAt;
            const detail = child.resultsCount === 1 ? `${child.resultsCount} result` : `${child.resultsCount} results`;
            const type = child.resultsCount > 0 ? 'info' : 'important';
            this.searches = [{label, value, created, detail, type}].concat(this.searches);
          });

          /* Listen for new view events and add them to the page */
          const viewRef = firebase.database().ref('/view').limitToLast(50);
          viewRef.on('child_added', data => {
            const child = data.val();
            const label = pathToSectionTitle(child.path);
            const value = child.name;
            const created = child._createdAt;
            this.views = [{label, value, created}].concat(this.views);
          });
        }
      }

      window.customElements.define(MyApp.is, MyApp);

      /**
       * Capitalizes the first letter of a string and returns it.
       */
      function capitalize(str) {
        return str[0].toUpperCase() + str.slice(1);
      }

      /**
       * Turns page paths into human-readable section titles for
       * the website.
       */
      function pathToSectionTitle(path) {
        const section = path.split('/')[2];
        if (section) {
          if (section === 'elements') {
            return 'Component Docs';
          }
          if (section === 'css') {
            return 'CSS Docs';
          }
          if (section === 'develop') {
            return 'Developer Guides';
          }
          if (section === 'design') {
            return 'Design Guidelines';
          }
          if (section === 'about') {
            return 'Getting Started';
          }
          return capitalize(section);
        }
        return 'Unknown';
      }
    }
  </script>
</dom-module>
